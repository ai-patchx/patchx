# PatchX

**[English](README.md)** | ä¸­æ–‡

ä¸€ä¸ªç”¨äºç®€åŒ– Android å¼€æºé¡¹ç›®ï¼ˆAOSPï¼‰ä»£ç è´¡çŒ®æµç¨‹çš„ Web æœåŠ¡ï¼Œæ”¯æŒ AI é©±åŠ¨çš„ patch å†²çªè§£å†³ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- ğŸ“¤ **æ–‡ä»¶ä¸Šä¼ **: æ”¯æŒæ‹–æ‹½ä¸Šä¼  Git patch æ–‡ä»¶
- âœ… **æ ¼å¼éªŒè¯**: è‡ªåŠ¨éªŒè¯ patch æ–‡ä»¶æ ¼å¼
- ğŸ¤– **AIå†²çªè§£å†³**: æ™ºèƒ½åˆ†æå’Œè§£å†³ä»£ç å†²çª
- ğŸ”„ **è‡ªåŠ¨æäº¤**: è‡ªåŠ¨æäº¤åˆ° Google AOSP Gerrit
- ğŸ“Š **çŠ¶æ€è·Ÿè¸ª**: å®æ—¶æ˜¾ç¤ºæäº¤è¿›åº¦å’Œç»“æœ
- ğŸ“± **å“åº”å¼è®¾è®¡**: æ”¯æŒæ¡Œé¢å’Œç§»åŠ¨è®¾å¤‡
- ğŸ” **ç”¨æˆ·ç™»å½•ä¸ä»¤ç‰Œé‰´æƒ**
- ğŸ§‘â€ğŸ’» **ç”¨æˆ·æ³¨å†Œ**ï¼šé‚®ç®±æ³¨å†Œ
- ğŸ“‹ **åŠ¨æ€é¡¹ç›®åˆ—è¡¨**: è‡ªåŠ¨ä» Gerrit è·å–æ‰€æœ‰é¡¹ç›®
- ğŸŒ¿ **åŠ¨æ€åˆ†æ”¯åˆ—è¡¨**: è‡ªåŠ¨è·å–æ‰€é€‰é¡¹ç›®çš„æ‰€æœ‰åˆ†æ”¯
- ğŸ” **å¯æœç´¢ä¸‹æ‹‰æ¡†**: æ”¯æŒå®æ—¶æœç´¢å’Œè¿‡æ»¤é¡¹ç›®å’Œåˆ†æ”¯
- âš¡ **æ™ºèƒ½ç¼“å­˜**: é¡¹ç›®å’Œåˆ†æ”¯æ•°æ®æœ¬åœ°ç¼“å­˜ 10 åˆ†é’Ÿï¼Œæå‡æ€§èƒ½å¹¶å‡å°‘ API è°ƒç”¨
- ğŸ–¥ï¸ **è¿œç¨‹èŠ‚ç‚¹ç®¡ç†**: é…ç½®å’Œç®¡ç†ç”¨äº git æ“ä½œçš„ SSH è¿œç¨‹èŠ‚ç‚¹
- ğŸ” **SSH è®¤è¯**: æ”¯æŒ SSH å¯†é’¥å’Œå¯†ç ä¸¤ç§è®¤è¯æ–¹å¼
- ğŸ“ **å·¥ä½œç›®å½•**: ä¸ºè¿œç¨‹ git æ“ä½œæŒ‡å®šå·¥ä½œä¸»ç›®å½•
- ğŸ”„ **Git ä»“åº“å…‹éš†**: åœ¨è¿œç¨‹èŠ‚ç‚¹ä¸Šå…‹éš† git ä»“åº“ï¼Œæ”¯æŒæŒ‡å®šç›®æ ‡é¡¹ç›®å’Œåˆ†æ”¯

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **å‰ç«¯**: React 18 + TypeScript + Tailwind CSS
- **åç«¯**: Cloudflare Workers + TypeScript
- **AIé›†æˆ**: æ”¯æŒ OpenAIã€Anthropic ç­‰ç¬¬ä¸‰æ–¹å¤§æ¨¡å‹
- **å­˜å‚¨**: Cloudflare D1ï¼ˆç”¨äºè¿œç¨‹èŠ‚ç‚¹å’Œåº”ç”¨è®¾ç½®ï¼‰ï¼ŒCloudflare KVï¼ˆç”¨äºç¼“å­˜ï¼‰
- **éƒ¨ç½²**: Cloudflare Workers + Pages

## ğŸ¤– AI å†²çªè§£å†³ç‰¹æ€§

### æ”¯æŒçš„ AI æä¾›å•†
- **OpenAI**: GPT-4, GPT-3.5 Turbo
- **Anthropic**: Claude 3 Sonnet, Claude 3 Haiku
- **è‡ªå®šä¹‰**: æ”¯æŒ OpenAI API å…¼å®¹çš„ä»»ä½•æä¾›å•†

### AI åŠŸèƒ½
- **æ™ºèƒ½å†²çªæ£€æµ‹**: è‡ªåŠ¨è¯†åˆ« patch ä¸­çš„ä»£ç å†²çª
- **å¤šæä¾›å•†å¯¹æ¯”**: åŒæ—¶ä½¿ç”¨å¤šä¸ª AI æä¾›å•†ï¼Œé€‰æ‹©æœ€ä½³è§£å†³æ–¹æ¡ˆ
- **ç½®ä¿¡åº¦è¯„ä¼°**: AI è§£å†³æ–¹æ¡ˆçš„å¯ä¿¡åº¦è¯„åˆ†
- **äººå·¥å®¡æŸ¥å»ºè®®**: æ ‡è®°éœ€è¦äººå·¥ç¡®è®¤çš„å¤æ‚å†²çª

## ğŸ“¦ å®‰è£…å’Œè¿è¡Œ

### æœ¬åœ°å¼€å‘

æœ¬é¡¹ç›®é‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œéœ€è¦åŒæ—¶è¿è¡Œä¸¤ä¸ªå¼€å‘æœåŠ¡å™¨ï¼š

#### ç»ˆç«¯ 1: å‰ç«¯å¼€å‘æœåŠ¡å™¨ï¼ˆViteï¼‰
```bash
# å®‰è£…ä¾èµ–
npm install

# æ ¼å¼åŒ–
npm run lint -- --fix

# å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
npm run dev
# è®¿é—®: http://localhost:5173
```

åœ¨ Cloudflare Workers ä¸Šä¸ºæµ‹è¯•è´¦å·å¯†ç è®¾ç½®å˜é‡ï¼š

```bash
wrangler secret put TEST_USER_PASSWORD
```

### é‰´æƒä¸æ³¨å†Œï¼ˆæœ¬åœ°å¼€å‘ï¼‰

å¤åˆ¶ `.env.example` ä¸º `.env.local` å¹¶é…ç½®ä»¥ä¸‹å˜é‡ï¼š
```bash
VITE_PUBLIC_SITE_URL=http://localhost:5173
GERRIT_BASE_URL=https://android-review.googlesource.com
GERRIT_USERNAME=your-gerrit-username
GERRIT_PASSWORD=your-gerrit-password-or-token
CACHE_VERSION=v1
```

é—ç•™çš„æµ‹è¯•è´¦å·ï¼ˆä»…ç”¨äº Worker API æµ‹è¯•ï¼‰ï¼š
- é»˜è®¤æµ‹è¯•è´¦å·ï¼š`ç”¨æˆ·å=patchx`ï¼Œ`å¯†ç =patchx`
- å¯é€šè¿‡ `TEST_USER_PASSWORD` è¦†ç›–æµ‹è¯•å¯†ç 
ç¤ºä¾‹ï¼š
- PowerShellï¼ˆWindowsï¼‰ï¼š
```powershell
$env:TEST_USER_PASSWORD="your_password"; npm run dev
```
- Vite åŠ©æ‰‹è„šæœ¬ï¼š
```bash
npm run dev:env  # ä½¿ç”¨ TEST_USER_PASSWORD=test123 å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```

#### ç»ˆç«¯ 2: åç«¯ API æœåŠ¡å™¨ï¼ˆWranglerï¼‰
```bash
# æ„å»º Cloudflare Workerï¼ˆAPIï¼‰
npm run build:worker

# å¯åŠ¨åç«¯ API å¼€å‘æœåŠ¡å™¨
wrangler dev
# API ç«¯ç‚¹: http://127.0.0.1:8787
```

**æ³¨æ„**: ä¸¤ä¸ªæœåŠ¡å™¨å¿…é¡»åŒæ—¶è¿è¡Œæ‰èƒ½å®Œæ•´ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ã€‚å‰ç«¯é€šè¿‡ API è°ƒç”¨ä¸åç«¯é€šä¿¡ã€‚

### ä»£ç æ£€æŸ¥
```bash
# è¿è¡Œ ESLint æ£€æŸ¥
npm run lint

# è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥
npm run check
```

### æ„å»ºå’Œéƒ¨ç½²

```bash
# æ„å»ºé¡¹ç›®
npm run build

# æ„å»º Cloudflare Workerï¼ˆAPIï¼‰
npm run build:worker
```

### Cloudflare Workers å¼€å‘

```bash
# å®‰è£… Wrangler
npm install -g wrangler

# ç™»å½• Cloudflare
wrangler login
```

**è®¤è¯æ–¹å¼ï¼š**

å¯¹äº Ubuntu/WSL ç”¨æˆ·ï¼Œæ¨èä½¿ç”¨ API Token æ–¹å¼ï¼ˆæ— éœ€æµè§ˆå™¨äº¤äº’ï¼‰ï¼š

1. è·å– API Tokenï¼šè®¿é—® https://dash.cloudflare.com/profile/api-tokens
2. è®¾ç½®ç¯å¢ƒå˜é‡ï¼š
   ```bash
   export CLOUDFLARE_API_TOKEN='your-api-token-here'
   ```
3. æŒä¹…åŒ–é…ç½®ï¼ˆæ·»åŠ åˆ° shell é…ç½®æ–‡ä»¶ï¼‰ï¼š
   ```bash
   # å¯¹äº bash
   echo 'export CLOUDFLARE_API_TOKEN="your-api-token-here"' >> ~/.bashrc
   source ~/.bashrc

   # å¯¹äº zsh
   echo 'export CLOUDFLARE_API_TOKEN="your-api-token-here"' >> ~/.zshrc
   source ~/.zshrc
   ```
4. éªŒè¯è®¤è¯ï¼š
   ```bash
   npx wrangler whoami
   ```

**æ³¨æ„ï¼š** è®¾ç½® `CLOUDFLARE_API_TOKEN` åï¼Œwrangler ä¼šè‡ªåŠ¨ä½¿ç”¨è¯¥ token è¿›è¡Œè®¤è¯ã€‚ä½¿ç”¨ API Token æ–¹å¼æ—¶æ— éœ€è¿è¡Œ `wrangler login`ã€‚

**é‡è¦æç¤ºï¼š** å¦‚æœæ‚¨å·²è®¾ç½® `CLOUDFLARE_API_TOKEN` å¹¶å°è¯•è¿è¡Œ `wrangler login`ï¼Œæ‚¨ä¼šæ”¶åˆ°é”™è¯¯ï¼š"You are logged in with an API Token. Unset the CLOUDFLARE_API_TOKEN in the environment to log in via OAuth." è¿™æ˜¯é¢„æœŸè¡Œä¸ºã€‚è¦æ”¹ç”¨ OAuth ç™»å½•ï¼š
```bash
# å–æ¶ˆè®¾ç½® API token
unset CLOUDFLARE_API_TOKEN

# ç„¶åè¿è¡Œ OAuth ç™»å½•
wrangler login
```

è¦åˆ‡æ¢å› API token è®¤è¯ï¼š
```bash
# é‡æ–°è®¾ç½® token
export CLOUDFLARE_API_TOKEN='your-api-token-here'
```

```bash
# æœ¬åœ°å¼€å‘ï¼ˆAPI Workerï¼‰
npm run build:worker
wrangler dev

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆAPI Workerï¼‰
npm run build:worker
wrangler deploy
# æˆ–ä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼š
npm run deploy
```

**æ³¨æ„ï¼š** `wrangler deploy` **ä¸ä¼š**é‡ç½®æ•°æ®åº“ã€‚æ•°æ®åº“é‡ç½®åŠŸèƒ½å¯é€šè¿‡ä»¥ä¸‹è„šæœ¬å•ç‹¬ä½¿ç”¨ã€‚

### æ•°æ®åº“ç®¡ç†

#### D1 æ•°æ®åº“è®¾ç½®

PatchX ä½¿ç”¨ Cloudflare D1 (SQLite) å­˜å‚¨è¿œç¨‹èŠ‚ç‚¹é…ç½®å’Œåº”ç”¨è®¾ç½®ã€‚

**åˆå§‹è®¾ç½®ï¼š**

1. **åˆ›å»º D1 æ•°æ®åº“ï¼š**
   ```bash
   # åˆ›å»ºç”Ÿäº§æ•°æ®åº“
   wrangler d1 create patchx-db

   # åˆ›å»º staging æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰
   wrangler d1 create patchx-db-staging
   ```

2. **æ›´æ–° wrangler.tomlï¼š**
   - ä»å‘½ä»¤è¾“å‡ºä¸­å¤åˆ¶ `database_id`
   - åœ¨ `wrangler.toml` ä¸­æ›´æ–°å®é™…çš„æ•°æ®åº“ IDï¼š
     ```toml
     [env.production]
     d1_databases = [
       { binding = "PATCHX_D1", database_name = "patchx-db", database_id = "your-actual-database-id" }
     ]
     ```

3. **åˆå§‹åŒ–æ•°æ®åº“ï¼š**
   ```bash
   # åˆå§‹åŒ–æœ¬åœ°æ•°æ®åº“ï¼ˆå¦‚æœè¡¨ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œä¿ç•™ç°æœ‰æ•°æ®ï¼‰
   npm run db:init:confirm

   # åˆå§‹åŒ–è¿œç¨‹ç”Ÿäº§æ•°æ®åº“
   bash scripts/reset-db.sh --init --env production --remote --confirm

   # æˆ–é‡ç½®æ•°æ®åº“ï¼ˆåˆ é™¤å¹¶é‡æ–°åˆ›å»ºæ‰€æœ‰è¡¨ï¼‰
   npm run db:reset:confirm

   # é‡ç½®è¿œç¨‹ç”Ÿäº§æ•°æ®åº“
   bash scripts/reset-db.sh --env production --remote --confirm
   ```

**ä½¿ç”¨ npm è„šæœ¬ï¼š**
```bash
# å¸¦ç¡®è®¤æç¤ºçš„åˆå§‹åŒ–æ•°æ®åº“
npm run db:init

# æ— éœ€ç¡®è®¤çš„åˆå§‹åŒ–æ•°æ®åº“
npm run db:init:confirm

# åˆå§‹åŒ–è¿œç¨‹æ•°æ®åº“ï¼ˆä¸ä½¿ç”¨ --envï¼Œä½¿ç”¨ patchx-dbï¼‰
npm run db:init:remote

# å¸¦ç¡®è®¤æç¤ºçš„é‡ç½®æ•°æ®åº“
npm run db:reset

# æ— éœ€ç¡®è®¤çš„é‡ç½®æ•°æ®åº“ï¼ˆè¯·è°¨æ…ä½¿ç”¨ï¼‰
npm run db:reset:confirm

# é‡ç½®è¿œç¨‹æ•°æ®åº“ï¼ˆä¸ä½¿ç”¨ --envï¼Œä½¿ç”¨ patchx-dbï¼‰
npm run db:reset:remote
```

**ç¯å¢ƒç‰¹å®šçš„æ“ä½œï¼š**
```bash
# åˆå§‹åŒ–ç”Ÿäº§æ•°æ®åº“ï¼ˆæœ¬åœ°ï¼‰
bash scripts/reset-db.sh --init --env production --confirm

# åˆå§‹åŒ–ç”Ÿäº§æ•°æ®åº“ï¼ˆè¿œç¨‹ï¼‰
bash scripts/reset-db.sh --init --env production --remote --confirm

# é‡ç½® staging æ•°æ®åº“ï¼ˆæœ¬åœ°ï¼‰
bash scripts/reset-db.sh --env staging --confirm

# é‡ç½® staging æ•°æ®åº“ï¼ˆè¿œç¨‹ï¼‰
bash scripts/reset-db.sh --env staging --remote --confirm
```

**æœ¬åœ° vs è¿œç¨‹æ•°æ®åº“ï¼š**
- **æœ¬åœ°æ•°æ®åº“**ï¼šå­˜å‚¨åœ¨ `.wrangler/state/v3/d1` ç›®å½•ä¸­ï¼Œç”¨äºæœ¬åœ°å¼€å‘
- **è¿œç¨‹æ•°æ®åº“**ï¼šCloudflare è´¦æˆ·ä¸­çš„ D1 æ•°æ®åº“ï¼Œç”¨äºç”Ÿäº§/staging éƒ¨ç½²
- ä½¿ç”¨ `--remote` æ ‡å¿—æ“ä½œè¿œç¨‹æ•°æ®åº“
- ä½¿ç”¨ `--env production` æˆ– `--env staging` æ—¶ï¼Œè„šæœ¬ä½¿ç”¨ `wrangler.toml` ä¸­çš„ `DB` ç»‘å®š
- ä¸ä½¿ç”¨ `--env` æ—¶ï¼Œè„šæœ¬ç›´æ¥ä½¿ç”¨æ•°æ®åº“åç§°ï¼ˆä¾‹å¦‚ï¼š`patchx-db`ï¼‰

**é‡è¦æç¤ºï¼š**
- æ•°æ®åº“æ“ä½œåœ¨ `wrangler deploy` æˆ– Cloudflare Pages éƒ¨ç½²è¿‡ç¨‹ä¸­**æ°¸è¿œä¸ä¼š**æ‰§è¡Œ
- é‡ç½®å‰è¯·åŠ¡å¿…å¤‡ä»½æ•°æ®
- é™¤éä½¿ç”¨ `--confirm`ï¼Œå¦åˆ™é‡ç½®è„šæœ¬éœ€è¦æ˜ç¡®ç¡®è®¤
- D1 æ•°æ®åº“ç»‘å®šåˆ°æ‚¨çš„ Cloudflare è´¦æˆ·ï¼Œé€šè¿‡ Worker ä¸­çš„ `DB` ç»‘å®šè®¿é—®

## ğŸ”„ å¼€å‘æœåŠ¡å™¨è¯´æ˜

### æœåŠ¡å™¨åŒºåˆ«

| æœåŠ¡å™¨ | ç«¯å£ | ç”¨é€” | è®¿é—®åœ°å€ |
|--------|------|------|----------|
| **Vite Dev Server** | 5173 | å‰ç«¯ React åº”ç”¨ | http://localhost:5173 |
| **Wrangler Dev Server** | 8787 | åç«¯ API Worker | http://127.0.0.1:8787 |

### å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆè®¿é—® `http://127.0.0.1:8787` æ˜¾ç¤º 404ï¼Ÿ**
A: Wrangler æœåŠ¡å™¨åªæä¾› API ç«¯ç‚¹ï¼Œæ²¡æœ‰æ ¹è·¯å¾„è·¯ç”±ã€‚è¯·è®¿é—®å…·ä½“çš„ API ç«¯ç‚¹ï¼Œå¦‚ï¼š
- `http://127.0.0.1:8787/api/ai/providers`
- `http://127.0.0.1:8787/api/upload`

**Q: å¦‚ä½•æµ‹è¯• API æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ**
A: å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æµ‹è¯• APIï¼š
```bash
# æµ‹è¯• AI æä¾›å•†åˆ—è¡¨
Invoke-WebRequest -Uri http://127.0.0.1:8787/api/ai/providers -Method GET

# æˆ–è€…ä½¿ç”¨ curlï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
curl http://127.0.0.1:8787/api/ai/providers
```

## ğŸ”§ AI é…ç½®

### ç¯å¢ƒå˜é‡é…ç½®

åœ¨ Cloudflare Workers ä¸­è®¾ç½®ä»¥ä¸‹ AI ç›¸å…³çš„ç¯å¢ƒå˜é‡ï¼š

```bash
# OpenAI é…ç½®
OPENAI_API_KEY=your-openai-api-key
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4
OPENAI_MAX_TOKENS=2000
OPENAI_TEMPERATURE=0.1

# Anthropic é…ç½®
ANTHROPIC_API_KEY=your-anthropic-api-key
ANTHROPIC_BASE_URL=https://api.anthropic.com/v1
ANTHROPIC_MODEL=claude-3-sonnet-20240229
ANTHROPIC_MAX_TOKENS=2000
ANTHROPIC_TEMPERATURE=0.1

# è‡ªå®šä¹‰ AI æä¾›å•†ï¼ˆå…¼å®¹OpenAI APIï¼‰
CUSTOM_AI_BASE_URL=https://your-custom-ai-provider.com/v1
CUSTOM_AI_API_KEY=your-custom-api-key
CUSTOM_AI_MODEL=gpt-3.5-turbo
CUSTOM_AI_MAX_TOKENS=2000
CUSTOM_AI_TEMPERATURE=0.1

# é‰´æƒç›¸å…³
TEST_USER_PASSWORD=your-secure-password

# æ³¨æ„ï¼šD1 æ•°æ®åº“é€šè¿‡ wrangler.toml ä¸­çš„ d1_databases ç»‘å®šé…ç½®
# ç¯å¢ƒå˜é‡ä¸­ä¸éœ€è¦æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
```

### é‚®ä»¶é€šçŸ¥é…ç½®

è¡¥ä¸æäº¤æµç¨‹é€šè¿‡ [Resend](https://resend.com/)ï¼ˆæä¾›å…è´¹å¥—é¤ï¼‰æˆ– MailChannels APIï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰å‘é€çŠ¶æ€é‚®ä»¶ã€‚

#### é€‰é¡¹ 1ï¼šResendï¼ˆæ¨è - æä¾›å…è´¹å¥—é¤ï¼‰

Resend æä¾›æ…·æ…¨çš„å…è´¹å¥—é¤ï¼š
- **æ¯æœˆ 3,000 å°é‚®ä»¶**
- **æ¯å¤© 100 å°é‚®ä»¶**

#### è·å– Resend API å¯†é’¥

1. **æ³¨å†Œ Resendï¼š**
   - è®¿é—® [Resend](https://resend.com/) å¹¶åˆ›å»ºå…è´¹è´¦æˆ·
   - å…è´¹å¥—é¤æ— éœ€ä¿¡ç”¨å¡

2. **è·å–æ‚¨çš„ API å¯†é’¥ï¼š**
   - ç™»å½•æ‚¨çš„ Resend æ§åˆ¶å°
   - å¯¼èˆªåˆ° API Keysï¼ˆAPI å¯†é’¥ï¼‰éƒ¨åˆ†
   - åˆ›å»ºæ–°çš„ API å¯†é’¥
   - å¤åˆ¶ API å¯†é’¥ï¼ˆä»¥ `re_` å¼€å¤´ï¼‰

3. **éªŒè¯æ‚¨çš„åŸŸåï¼ˆå‘é€é‚®ä»¶å¿…éœ€ï¼‰ï¼š**
   - åœ¨ Resend æ§åˆ¶å°ä¸­ï¼Œè½¬åˆ° Domainsï¼ˆåŸŸåï¼‰
   - æ·»åŠ å¹¶éªŒè¯æ‚¨çš„å‘é€åŸŸå
   - æŒ‰ç…§ DNS éªŒè¯è¯´æ˜æ“ä½œ
   - ç¡®ä¿æ‚¨çš„ `RESEND_FROM_EMAIL` ä½¿ç”¨å·²éªŒè¯çš„åŸŸå

#### é€‰é¡¹ 2ï¼šMailChannels APIï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

**é‡è¦æç¤ºï¼š** è‡ª 2024 å¹´ 8 æœˆèµ·ï¼ŒMailChannels å·²åœæ­¢ä¸º Cloudflare Workers æä¾›å…è´¹æœåŠ¡ã€‚æ‚¨ç°åœ¨éœ€è¦æ³¨å†Œ MailChannels Email API è®¡åˆ’æ‰èƒ½å‘é€é‚®ä»¶ã€‚

#### è·å– MailChannels API å¯†é’¥

1. **æ³¨å†Œ MailChannels Email APIï¼š**
   - è®¿é—® [MailChannels Email API](https://mailchannels.com/email-api) å¹¶æ³¨å†Œä¸€ä¸ªè®¡åˆ’
   - é€‰æ‹©é€‚åˆæ‚¨é‚®ä»¶å‘é€é‡çš„è®¡åˆ’

2. **è·å–æ‚¨çš„ API å¯†é’¥ï¼š**
   - ç™»å½•æ‚¨çš„ MailChannels æ§åˆ¶å°
   - å¯¼èˆªåˆ° API Keysï¼ˆAPI å¯†é’¥ï¼‰éƒ¨åˆ†
   - åˆ›å»ºæ–°çš„ API å¯†é’¥
   - å¤åˆ¶ API å¯†é’¥ï¼ˆä¹‹åå°†æ— æ³•å†æ¬¡æŸ¥çœ‹ï¼‰

3. **éªŒè¯æ‚¨çš„åŸŸåï¼ˆå¦‚éœ€è¦ï¼‰ï¼š**
   - æŸäº›è®¡åˆ’éœ€è¦åŸŸåéªŒè¯
   - æŒ‰ç…§ MailChannels çš„è¯´æ˜éªŒè¯æ‚¨çš„å‘é€åŸŸå
   - ç¡®ä¿æ‚¨çš„ `MAILCHANNELS_FROM_EMAIL` ä½¿ç”¨å·²éªŒè¯çš„åŸŸå

#### Resend é…ç½®

è¯·åœ¨ `wrangler.toml`ï¼ˆæˆ– Cloudflare åå°ï¼‰ä¸­ä¸ºå„ç¯å¢ƒè®¾ç½®ä»¥ä¸‹å˜é‡ï¼š

```bash
RESEND_API_KEY=re_your-resend-api-key
RESEND_FROM_EMAIL=no-reply@your-domain.com
RESEND_FROM_NAME="PatchX"
RESEND_REPLY_TO_EMAIL=patchx@your-domain.com   # å¯é€‰
```

**å®‰å…¨æç¤ºï¼š** å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®ä½¿ç”¨ Cloudflare Workers å¯†é’¥è€Œä¸æ˜¯å°† API å¯†é’¥å­˜å‚¨åœ¨ `wrangler.toml` ä¸­ï¼š

```bash
# è®¾ç½®ä¸ºå¯†é’¥ï¼ˆä¸åœ¨ wrangler.toml ä¸­ï¼‰
wrangler secret put RESEND_API_KEY
```

ç„¶åé€šè¿‡ `env.RESEND_API_KEY` åœ¨ worker ä»£ç ä¸­è®¿é—®å®ƒã€‚

#### MailChannels é…ç½®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

å¦‚æœæœªé…ç½® Resendï¼Œç³»ç»Ÿå°†å›é€€åˆ° MailChannels APIï¼š

```bash
MAILCHANNELS_FROM_EMAIL=no-reply@your-domain.com
MAILCHANNELS_FROM_NAME="PatchX"
MAILCHANNELS_REPLY_TO_EMAIL=patchx@your-domain.com   # å¯é€‰
MAILCHANNELS_API_ENDPOINT=https://api.mailchannels.net/tx/v1/send   # å¯é€‰è¦†å†™
MAILCHANNELS_API_KEY=your-api-key-here   # ä»˜è´¹è®¡åˆ’å¿…éœ€
```

**å®‰å…¨æç¤ºï¼š** å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®ä½¿ç”¨ Cloudflare Workers å¯†é’¥ï¼š

```bash
# è®¾ç½®ä¸ºå¯†é’¥ï¼ˆä¸åœ¨ wrangler.toml ä¸­ï¼‰
wrangler secret put MAILCHANNELS_API_KEY
```

#### æµ‹è¯•é‚®ä»¶é…ç½®

é…ç½®å®Œæˆåï¼Œæ‚¨å¯ä»¥ä»è®¾ç½®é¡µé¢æµ‹è¯•æ‚¨çš„é‚®ä»¶è®¾ç½®ï¼š
1. å¯¼èˆªåˆ°è®¾ç½®é¡µé¢
2. æ»šåŠ¨åˆ°"é‚®ä»¶é…ç½®æµ‹è¯•"éƒ¨åˆ†
3. è¾“å…¥æµ‹è¯•é‚®ç®±åœ°å€
4. ç‚¹å‡»"å‘é€æµ‹è¯•é‚®ä»¶"

æµ‹è¯•å°†éªŒè¯æ‚¨çš„é‚®ä»¶é…ç½®ï¼ˆResend æˆ– MailChannelsï¼‰æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚å¦‚æœé…ç½®äº† Resendï¼Œå°†ä½¿ç”¨ Resendï¼›å¦åˆ™å°†å›é€€åˆ° MailChannels APIã€‚

### å‰ç«¯ç¯å¢ƒå˜é‡ï¼ˆViteï¼‰

ä¸ºé¿å…ç«¯ç‚¹ç¡¬ç¼–ç å¹¶æŒ‰ç¯å¢ƒåŒºåˆ†é…ç½®ï¼Œè¯·è®¾ç½®å‰ç«¯ç”¨äºè®¿é—®åç«¯ Worker çš„åŸºåœ°å€ï¼š

```bash
VITE_WORKER_BASE_URL=https://patchx-service.angersax.workers.dev
```

ç™»å½•é¡µé¢å°†è°ƒç”¨ `${VITE_WORKER_BASE_URL}/api/auth/login`ï¼Œå¯åœ¨ä¸åŒç¯å¢ƒè®¾ç½®ä¸åŒå€¼ï¼ˆå¦‚ staging/productionï¼‰ã€‚

#### Cloudflare Pagesï¼šç¯å¢ƒå˜é‡é…ç½®

**æ¨èæ–¹å¼ï¼šä½¿ç”¨ Worker é…ç½®ç«¯ç‚¹ï¼ˆè‡ªåŠ¨ï¼‰**

Worker é€šè¿‡ `/api/config/public` ç«¯ç‚¹æä¾›é…ç½®ï¼Œå‰ç«¯ä¼šè‡ªåŠ¨ä½¿ç”¨ï¼š

1. ç¡®ä¿ `.env.local` åŒ…å«æ‰€éœ€å˜é‡ï¼ˆè§ `.env.example`ï¼‰
2. è¿è¡ŒåŒæ­¥è„šæœ¬å°†ç¯å¢ƒå˜é‡åŒæ­¥åˆ° `wrangler.toml`ï¼š
   ```bash
   npm run sync:env
   ```
3. éƒ¨ç½² Worker åï¼Œå‰ç«¯ä¼šè‡ªåŠ¨ä» `/api/config/public` ç«¯ç‚¹è·å–é…ç½®

**æ›¿ä»£æ–¹å¼ï¼šåœ¨ Cloudflare Pages ä»ªè¡¨æ¿ä¸­æ‰‹åŠ¨è®¾ç½®**

å¦‚æœæ‚¨æ›´å–œæ¬¢åœ¨ Cloudflare Pages ä¸­ç›´æ¥è®¾ç½®ï¼š

1. è¿›å…¥ Cloudflare Pages â†’ é€‰æ‹©é¡¹ç›® â†’ Settings â†’ Environment variables
2. åœ¨ "Production" ä¸ "Preview"ï¼ˆæŒ‰éœ€ï¼‰æ·»åŠ ä»¥ä¸‹å˜é‡ï¼š
   - `VITE_PUBLIC_SITE_URL` â†’ å¯¹å¤–è®¿é—®åœ°å€ï¼ˆå¦‚ `https://patchx.pages.dev`ï¼‰
3. é‡æ–°éƒ¨ç½² Pages é¡¹ç›®ä½¿æ–°çš„ç¯å¢ƒå˜é‡ç”Ÿæ•ˆã€‚

**æ³¨æ„ï¼š** LiteLLM é…ç½®ç°åœ¨é€šè¿‡è®¾ç½®é¡µé¢ï¼ˆä»…ç®¡ç†å‘˜ï¼‰ç®¡ç†ï¼Œå¹¶å­˜å‚¨åœ¨ D1 æ•°æ®åº“ä¸­ï¼Œä¸å†ä½¿ç”¨ç¯å¢ƒå˜é‡ã€‚è¯·å‚é˜…ä¸‹é¢çš„ LiteLLM é…ç½®éƒ¨åˆ†ã€‚

#### Cloudflare Workersï¼šé€šè¿‡ `wrangler.toml` é…ç½®

åœ¨ Workers ç«¯é…ç½®ç¯å¢ƒå˜é‡ï¼Œå¹¶ç”±å‰ç«¯åœ¨è¿è¡Œæ—¶æ‹‰å–ï¼š

1. ä» `.env.local` åŒæ­¥ç¯å¢ƒå˜é‡åˆ° `wrangler.toml`ï¼š
   ```bash
   npm run sync:env
   ```

2. Worker æä¾›å…¬å…±é…ç½®ç«¯ç‚¹ `/api/config/public`ï¼Œè¿”å› `{ publicSiteUrl }`ã€‚

3. D1 æ•°æ®åº“é€šè¿‡ `wrangler.toml` ä¸­çš„ `d1_databases` ç»‘å®šé…ç½®ï¼š
   ```toml
   [env.production]
   d1_databases = [
     { binding = "PATCHX_D1", database_name = "patchx-db", database_id = "your-database-id" }
   ]
   ```

### è¿œç¨‹èŠ‚ç‚¹é…ç½®

è¿œç¨‹èŠ‚ç‚¹å…è®¸æ‚¨é€šè¿‡ SSH åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œ git æ“ä½œã€‚è¿™å¯¹äºåœ¨è¿œç¨‹æ„å»ºæœåŠ¡å™¨ä¸Šåº”ç”¨è¡¥ä¸å’Œç®¡ç† git ä»“åº“éå¸¸æœ‰ç”¨ã€‚

#### åŠŸèƒ½ç‰¹æ€§

- **SSH è¿æ¥ç®¡ç†**: é…ç½®è¿œç¨‹æœåŠ¡å™¨çš„ä¸»æœºã€ç«¯å£å’Œç”¨æˆ·å
- **èº«ä»½è®¤è¯**: æ”¯æŒ SSH å¯†é’¥å’Œå¯†ç ä¸¤ç§è®¤è¯æ–¹å¼
- **å·¥ä½œä¸»ç›®å½•**: ä¸º git æ“ä½œæŒ‡å®šå·¥ä½œç›®å½•è·¯å¾„
- **è¿æ¥æµ‹è¯•**: æµ‹è¯• SSH è¿æ¥å¹¶éªŒè¯å·¥ä½œä¸»ç›®å½•
- **D1 æ•°æ®åº“å­˜å‚¨**: è¿œç¨‹èŠ‚ç‚¹é…ç½®å­˜å‚¨åœ¨ Cloudflare D1 æ•°æ®åº“ä¸­

#### è®¾ç½®è¿œç¨‹èŠ‚ç‚¹

1. **è®¿é—®è®¾ç½®é¡µé¢**: å¯¼èˆªåˆ°è®¾ç½®é¡µé¢ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
2. **æ·»åŠ è¿œç¨‹èŠ‚ç‚¹**: ç‚¹å‡»"æ·»åŠ è¿œç¨‹èŠ‚ç‚¹"æŒ‰é’®
3. **é…ç½®èŠ‚ç‚¹**:
   - **åç§°**: èŠ‚ç‚¹çš„æè¿°æ€§åç§°ï¼ˆä¾‹å¦‚ï¼š"Ubuntu æ„å»ºæœåŠ¡å™¨ 1"ï¼‰
   - **ä¸»æœº**: è¿œç¨‹æœåŠ¡å™¨çš„ IP åœ°å€æˆ–ä¸»æœºå
   - **ç«¯å£**: SSH ç«¯å£ï¼ˆé»˜è®¤ï¼š22ï¼‰
   - **ç”¨æˆ·å**: SSH ç”¨æˆ·å
   - **å·¥ä½œä¸»ç›®å½•**: å¯é€‰çš„å·¥ä½œç›®å½•è·¯å¾„ï¼ˆä¾‹å¦‚ï¼š`/home/username/my-tmp/patchx`ï¼‰
   - **SSH Service API URL**: å¯é€‰çš„ SSH æœåŠ¡ API URLï¼Œç”¨äºæ‰§è¡Œå‘½ä»¤ï¼ˆä¾‹å¦‚ï¼š`https://your-ssh-service.com/api/ssh` æˆ– `http://your-ip/api/ssh`ï¼‰
   - **SSH Service API Key**: å¯é€‰çš„ API å¯†é’¥ï¼Œç”¨äº SSH æœåŠ¡ API è®¤è¯
   - **è®¤è¯ç±»å‹**: é€‰æ‹© SSH å¯†é’¥æˆ–å¯†ç 
   - **SSH å¯†é’¥/å¯†ç **: æä¾›è®¤è¯å‡­æ®

4. **æµ‹è¯•è¿æ¥**: ç‚¹å‡»"æµ‹è¯•è¿æ¥"ä»¥éªŒè¯ï¼š
   - SSH è¿æ¥æ€§ï¼ˆä¸»æœºã€ç«¯å£ã€æ¨ªå¹…ã€å»¶è¿Ÿï¼‰
   - å·¥ä½œä¸»ç›®å½•ï¼ˆå¦‚æœé…ç½®äº† SSH Service API URLï¼‰

#### SSH æœåŠ¡ API é…ç½®ï¼ˆå¯é€‰ï¼‰

ä¸ºäº†éªŒè¯å·¥ä½œä¸»ç›®å½•å’Œæ‰§è¡Œ git æ“ä½œï¼Œæ‚¨å¯ä»¥æŒ‰èŠ‚ç‚¹é…ç½®å¤–éƒ¨ SSH æœåŠ¡ APIï¼š

1. **åœ¨è®¾ç½®é¡µé¢ä¸­é…ç½®**: æ·»åŠ æˆ–ç¼–è¾‘è¿œç¨‹èŠ‚ç‚¹æ—¶ï¼Œå¡«å†™ï¼š
   - **SSH Service API URL**: æ‚¨çš„ SSH æœåŠ¡ API ç«¯ç‚¹ URLï¼ˆä¾‹å¦‚ï¼š`https://your-domain.com/api/ssh` æˆ– `http://your-ip/api/ssh`ï¼‰
     - **æ³¨æ„**ï¼šè¯·æä¾›ä»¥ `/api/ssh` ç»“å°¾çš„åŸºç¡€ URLï¼ˆä¸åŒ…å« `/execute`ï¼‰ã€‚ç³»ç»Ÿåœ¨å‘èµ·è¯·æ±‚æ—¶ä¼šè‡ªåŠ¨è¿½åŠ  `/execute`ã€‚
     - **ç«¯å£é…ç½®**ï¼šä½¿ç”¨æä¾›çš„ nginx åå‘ä»£ç†é…ç½®ï¼ˆdocker-compose.yml å’Œ nginx.confï¼‰æ—¶ï¼ŒSSH æœåŠ¡ API ä½¿ç”¨æ ‡å‡†ç«¯å£ 80ï¼ˆHTTPï¼‰å’Œ 443ï¼ˆHTTPSï¼‰ã€‚ç”±äº 443 æ˜¯é»˜è®¤çš„ HTTPS ç«¯å£ï¼Œæ‚¨æ— éœ€åœ¨ URL ä¸­åŒ…å«ç«¯å£å·ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨ `https://your-domain.com/api/ssh` è€Œä¸æ˜¯ `https://your-domain.com:443/api/ssh`ï¼‰ã€‚
   - **SSH Service API Key**: ç”¨äºè®¤è¯çš„ API å¯†é’¥ï¼ˆå¯é€‰ï¼Œä½†å¦‚æœæ‚¨çš„ SSH æœåŠ¡éœ€è¦è®¤è¯ï¼Œåˆ™æ¨èé…ç½®ï¼‰

2. **Docker éƒ¨ç½²é…ç½®**ï¼šå¦‚æœæ‚¨ä½¿ç”¨ Docker Compose éƒ¨ç½² SSH æœåŠ¡ APIï¼Œéœ€è¦è®¾ç½® `GIT_WORK_DIR` ç¯å¢ƒå˜é‡ä»¥åŒ¹é…ä¸ºè¿œç¨‹èŠ‚ç‚¹é…ç½®çš„"å·¥ä½œä¸»ç›®å½•"è·¯å¾„ï¼š
   ```bash
   # è®¾ç½® GIT_WORK_DIR ä»¥åŒ¹é…è¿œç¨‹èŠ‚ç‚¹çš„"å·¥ä½œä¸»ç›®å½•"è·¯å¾„
   export GIT_WORK_DIR=/home/your-user/git-work  # æ›¿æ¢ä¸ºæ‚¨çš„å®é™…å·¥ä½œä¸»ç›®å½•è·¯å¾„
   docker-compose up -d
   ```
   æˆ–åœ¨ `.env` æ–‡ä»¶ä¸­ï¼š
   ```bash
   GIT_WORK_DIR=/home/your-user/git-work  # å¿…é¡»ä¸è¿œç¨‹èŠ‚ç‚¹è®¾ç½®ä¸­çš„"å·¥ä½œä¸»ç›®å½•"åŒ¹é…
   ```

3. **SSH æœåŠ¡ API è¦æ±‚**:
   - ç«¯ç‚¹: `POST /execute`
   - è¯·æ±‚ä½“:
     ```json
     {
       "host": "string",
       "port": number,
       "username": "string",
       "authType": "key" | "password",
       "sshKey": "string",
       "password": "string",
       "command": "string"
     }
     ```
   - å“åº”:
     ```json
     {
       "success": boolean,
       "output": "string",
       "error": "string"
     }
     ```
   - è®¤è¯: å¦‚æœæä¾›äº† API å¯†é’¥ï¼ŒWorker å°†å‘é€ `Authorization: Bearer <api-key>` è¯·æ±‚å¤´

4. **æ¯èŠ‚ç‚¹é…ç½®çš„ä¼˜åŠ¿**:
   - æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä½¿ç”¨ä¸åŒçš„ SSH æœåŠ¡ç«¯ç‚¹
   - API å¯†é’¥å®‰å…¨åœ°å­˜å‚¨åœ¨ D1 æ•°æ®åº“ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç‹¬ç«‹
   - æ›´å¥½çš„ç»„ç»‡æ€§å’Œçµæ´»æ€§

5. **æ²¡æœ‰ SSH æœåŠ¡ API**: è¿æ¥æµ‹è¯•ä»ä¼šéªŒè¯ SSH è¿æ¥æ€§ï¼Œä½†å·¥ä½œä¸»ç›®å½•éªŒè¯å’Œ git æ“ä½œå°†è¢«è·³è¿‡ã€‚

#### æ•°æ®åº“è®¾ç½®

åˆå§‹åŒ–æˆ–é‡ç½® D1 æ•°æ®åº“æ—¶ä¼šè‡ªåŠ¨åˆ›å»º `remote_nodes` å’Œ `app_settings` è¡¨ï¼š

```bash
# åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå®‰å…¨ï¼Œä¿ç•™ç°æœ‰æ•°æ®ï¼‰
npm run db:init:confirm

# æˆ–é‡ç½®æ•°æ®åº“ï¼ˆåˆ é™¤å¹¶é‡æ–°åˆ›å»ºæ‰€æœ‰è¡¨ï¼‰
npm run db:reset:confirm
```

**remote_nodes è¡¨**åŒ…æ‹¬ï¼š
- èŠ‚ç‚¹å…ƒæ•°æ®ï¼ˆåç§°ã€ä¸»æœºã€ç«¯å£ã€ç”¨æˆ·åï¼‰
- è®¤è¯å‡­æ®ï¼ˆSSH å¯†é’¥æˆ–å¯†ç ï¼‰
- å·¥ä½œä¸»ç›®å½•è·¯å¾„
- SSH æœåŠ¡ API é…ç½®ï¼ˆSSH Service API URL å’Œ Keyï¼‰
- æ—¶é—´æˆ³ï¼ˆcreated_at, updated_atï¼‰

**app_settings è¡¨**åŒ…æ‹¬ï¼š
- åº”ç”¨ç¨‹åºè®¾ç½®çš„é”®å€¼å¯¹
- LiteLLM é…ç½®ï¼ˆåŸºç¡€ URLã€API å¯†é’¥ã€æ¨¡å‹åç§°ï¼‰
- æ—¶é—´æˆ³ï¼ˆcreated_at, updated_atï¼‰

**æ•°æ®åº“æ¶æ„ï¼š**

æ•°æ®åº“æ¶æ„å®šä¹‰åœ¨ `schema.sql` ä¸­ã€‚è¡¨ä½¿ç”¨ä¸ Cloudflare D1 å…¼å®¹çš„ SQLite è¯­æ³•ï¼š

- UUID å­˜å‚¨ä¸º TEXTï¼ˆSQLite æ²¡æœ‰åŸç”Ÿ UUID ç±»å‹ï¼‰
- æ—¶é—´æˆ³ä½¿ç”¨ ISO 8601 æ ¼å¼ï¼ˆTEXT ç±»å‹ï¼Œé»˜è®¤å€¼ä¸º `datetime('now')`ï¼‰
- åœ¨ç»å¸¸æŸ¥è¯¢çš„å­—æ®µï¼ˆhostã€usernameã€keyï¼‰ä¸Šåˆ›å»ºç´¢å¼•

#### ä½¿ç”¨è¿œç¨‹èŠ‚ç‚¹

æäº¤è¡¥ä¸æ—¶ï¼š
1. ä»ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©è¿œç¨‹èŠ‚ç‚¹ï¼ˆå¯é€‰ï¼‰
2. å¦‚æœé€‰æ‹©äº†è¿œç¨‹èŠ‚ç‚¹ï¼Œè¯·æä¾› Git ä»“åº“ URL
3. ç³»ç»Ÿå°†åœ¨è¿œç¨‹èŠ‚ç‚¹ä¸Šæ‰§è¡Œ git æ“ä½œï¼š
   - ä½¿ç”¨æŒ‡å®šçš„ç›®æ ‡é¡¹ç›®å’Œåˆ†æ”¯å…‹éš†ä»“åº“
   - åº”ç”¨è¡¥ä¸
   - å¦‚æœ‰éœ€è¦ï¼Œæ‰§è¡Œå†²çªè§£å†³
   - æäº¤å¹¶æ¨é€æ›´æ”¹

#### Git å…‹éš†æ“ä½œ

ç³»ç»Ÿæ”¯æŒåœ¨è¿œç¨‹èŠ‚ç‚¹ä¸Šå…‹éš† git ä»“åº“ï¼Œå…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š
- **ç›®æ ‡é¡¹ç›®**: æŒ‡å®šè¦å…‹éš†çš„ git ä»“åº“ URL
- **ç›®æ ‡åˆ†æ”¯**: ä»ä»“åº“å…‹éš†ç‰¹å®šåˆ†æ”¯
- **å·¥ä½œä¸»ç›®å½•**: ä½¿ç”¨è¿œç¨‹èŠ‚ç‚¹è®¾ç½®ä¸­é…ç½®çš„å·¥ä½œä¸»ç›®å½•
- **è‡ªåŠ¨ç›®å½•ç®¡ç†**: è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ç›®å½•åç§°æˆ–ä½¿ç”¨æŒ‡å®šçš„ç›®æ ‡ç›®å½•
- **ä»“åº“æ›´æ–°**: å¦‚æœç›®æ ‡ç›®å½•å·²å­˜åœ¨ï¼Œç³»ç»Ÿå°†æ›´æ–°ä»“åº“è€Œä¸æ˜¯é‡æ–°å…‹éš†

Git å…‹éš†åŠŸèƒ½ä½¿ç”¨åµŒå…¥åœ¨ SSH æœåŠ¡ API ä¸­çš„ bash æ¨¡æ¿è„šæœ¬ã€‚å½“ä¸ºè¿œç¨‹èŠ‚ç‚¹é…ç½®äº† SSH æœåŠ¡ API æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨ä¸“ç”¨çš„ `/git-clone` ç«¯ç‚¹ä»¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚

### Gerrit é…ç½®

åœ¨ Cloudflare Workers ä¸­é…ç½®ä¸ AOSP Gerrit äº¤äº’æ‰€éœ€çš„ç¯å¢ƒå˜é‡ä¸å¯†é’¥ã€‚

**é€‰é¡¹ 1ï¼šä» .env.local åŒæ­¥ï¼ˆæ¨èï¼‰**

1. åœ¨ `.env.local` ä¸­æ·»åŠ  Gerrit å‡­æ®å’Œç¼“å­˜ç‰ˆæœ¬ï¼š
   ```bash
   GERRIT_BASE_URL=https://android-review.googlesource.com
   GERRIT_USERNAME=your-gerrit-username
   GERRIT_PASSWORD=your-gerrit-password-or-token
   CACHE_VERSION=v1
   ```

2. åŒæ­¥åˆ° `wrangler.toml`ï¼š
   ```bash
   npm run sync:env
   ```

3. éƒ¨ç½² Workerï¼š
   ```bash
   npm run deploy
   ```

**æ³¨æ„ï¼š** `sync:env` è„šæœ¬ä¹Ÿä¼šå°† `CACHE_VERSION` ä» `.env.local` åŒæ­¥åˆ° `wrangler.toml`ã€‚æ›´æ–° `CACHE_VERSION`ï¼ˆä¾‹å¦‚æ”¹ä¸º `v2`ï¼‰å¹¶é‡æ–°éƒ¨ç½²ï¼Œå¯ä»¥æ¸…é™¤æ‰€æœ‰é¡¹ç›®å’Œåˆ†æ”¯çš„ç¼“å­˜å“åº”ã€‚

**é€‰é¡¹ 2ï¼šæ‰‹åŠ¨é…ç½®**

æˆ–è€…ï¼Œæ‰‹åŠ¨é…ç½® Gerrit å‡­æ®ï¼š

```bash
# Gerrit åŸºæœ¬é…ç½®ï¼ˆwrangler.toml ä¸­ varsï¼‰
GERRIT_BASE_URL=https://android-review.googlesource.com
MAX_FILE_SIZE=10485760           # 10MB
RATE_LIMIT_WINDOW=900000         # 15åˆ†é’Ÿï¼ˆæ¯«ç§’ï¼‰
RATE_LIMIT_MAX=10                # çª—å£å†…æœ€å¤§è¯·æ±‚æ•°

# Gerrit å‡­æ®ï¼ˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Wrangler Secrets å­˜å‚¨ï¼‰
# å¼€å‘ç¯å¢ƒå¯ä»¥åœ¨ wrangler.toml ä¸­ä½¿ç”¨ vars
# ç”Ÿäº§ç¯å¢ƒçš„æ•æ„Ÿä¿¡æ¯åº”ä½¿ç”¨ secrets ç®¡ç†ï¼š
wrangler secret put GERRIT_USERNAME
wrangler secret put GERRIT_PASSWORD
```

**æ³¨æ„ï¼š** `sync:env` è„šæœ¬ä¼šè‡ªåŠ¨å°† `GERRIT_USERNAME` å’Œ `GERRIT_PASSWORD` ä½œä¸º vars æ·»åŠ åˆ° `wrangler.toml`ã€‚å¯¹äºç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼Œå»ºè®®ä½¿ç”¨ Wrangler secrets ä»¥è·å¾—æ›´å¥½çš„å®‰å…¨æ€§ï¼š

```bash
# AI æä¾›å•†å¯†é’¥ï¼ˆåŒæ ·ä½¿ç”¨ secrets ç®¡ç†ï¼‰
wrangler secret put OPENAI_API_KEY
wrangler secret put ANTHROPIC_API_KEY
wrangler secret put CUSTOM_AI_API_KEY
```

### KV å‘½åç©ºé—´

ç¡®ä¿åœ¨ `wrangler.toml` ä¸­ç»‘å®š KV å‘½åç©ºé—´ï¼š

```toml
[env.production]
kv_namespaces = [
  { binding = "PATCHX_KV", id = "<your_kv_id>" }
]
d1_databases = [
  { binding = "PATCHX_D1", database_name = "patchx-db", database_id = "<your_database_id>" }
]
```

### AI åŠŸèƒ½å¯ç”¨

AI å†²çªè§£å†³åŠŸèƒ½ä¼šæ ¹æ®é…ç½®è‡ªåŠ¨å¯ç”¨ï¼š

1. **è‡ªåŠ¨æ£€æµ‹**: ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å¯ç”¨çš„ AI æä¾›å•†
2. **å¤šæä¾›å•†æ¨¡å¼**: å¯ä»¥åŒæ—¶é…ç½®å¤šä¸ª AI æä¾›å•†è¿›è¡Œå¯¹æ¯”
3. **æ™ºèƒ½é€‰æ‹©**: ç³»ç»Ÿä¼šé€‰æ‹©ç½®ä¿¡åº¦æœ€é«˜çš„ AI è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ API æ–‡æ¡£

### é‰´æƒ API

#### ç™»å½•
```
POST /api/auth/login
```

Request:
```json
{
  "username": "patchx",
  "password": "<password>"
}
```

Response:
```json
{
  "user": { "id": "user-123", "username": "patchx" },
  "token": "<base64-token>",
  "message": "ç™»å½•æˆåŠŸ"
}
```

#### å½“å‰ç”¨æˆ·ï¼ˆéœ€è¦é‰´æƒï¼‰
```
GET /api/auth/me
```

Headers:
```
Authorization: Bearer <token>
```

Response:
```json
{
  "user": { "id": "user-123", "username": "patchx" },
  "message": "è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ"
}
```

è¯´æ˜ï¼š
- å—ä¿æŠ¤çš„æ¥å£éœ€è¦æºå¸¦ `Authorization: Bearer <token>` è¯·æ±‚å¤´ã€‚
- å‰ç«¯åœ¨ç™»å½•åä¼šè‡ªåŠ¨æ·»åŠ è¯¥è¯·æ±‚å¤´ã€‚

### AI å†²çªè§£å†³ API

#### è§£å†³ä»£ç å†²çª
```
POST /api/ai/resolve-conflict
```

Request:
```json
{
  "originalCode": "åŸå§‹ä»£ç å†…å®¹",
  "incomingCode": "ä¼ å…¥çš„ patch ä»£ç ",
  "currentCode": "å½“å‰ä»£ç å†…å®¹",
  "filePath": "æ–‡ä»¶è·¯å¾„",
  "provider": "openai",
  "useMultipleProviders": true
}
```

Response:
```json
{
  "success": true,
  "data": {
    "resolvedCode": "è§£å†³åçš„ä»£ç ",
    "explanation": "è§£å†³ç­–ç•¥è§£é‡Š",
    "confidence": 0.85,
    "suggestions": ["å»ºè®®1", "å»ºè®®2"],
    "requiresManualReview": false
  }
}
```

### Patch ä¸Šä¼ ä¸æäº¤ API

#### ä¸Šä¼  Patch æ–‡ä»¶
```
POST /api/upload
```

Requestï¼ˆ`multipart/form-data`ï¼‰ï¼š
- `file`: Git patch æ–‡ä»¶
- `project`: ç›®æ ‡é¡¹ç›®ï¼ˆä¾‹å¦‚ `platform/frameworks/base`ï¼‰

Response:
```json
{
  "success": true,
  "data": {
    "uploadId": "<id>",
    "status": "success",
    "message": "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ"
  }
}
```

#### åˆ›å»ºæäº¤å¹¶å¼‚æ­¥æ¨é€åˆ° Gerrit
```
POST /api/submit
```

Requestï¼ˆ`application/json`ï¼‰ï¼š
```json
{
  "uploadId": "<id>",
  "subject": "æäº¤æ ‡é¢˜",
  "description": "æäº¤æè¿°",
  "branch": "refs/heads/master"
}
```

Responseï¼š
```json
{
  "success": true,
  "data": {
    "submissionId": "<id>",
    "status": "processing"
  }
}
```

#### æŸ¥è¯¢æäº¤çŠ¶æ€
```
GET /api/status/<submissionId>
```

Responseï¼š
```json
{
  "success": true,
  "data": {
    "status": "completed",
    "changeId": "12345",
    "changeUrl": "https://android-review.googlesource.com/#/c/12345/",
    "createdAt": "2025-11-14T12:00:00Z",
    "error": null
  }
}
```

#### åœ¨è¿œç¨‹èŠ‚ç‚¹ä¸Šå…‹éš† git ä»“åº“
```
POST /api/git/clone
```

**æè¿°ï¼š** åœ¨è¿œç¨‹èŠ‚ç‚¹ä¸Šå…‹éš† git ä»“åº“ï¼Œæ”¯æŒæŒ‡å®šç›®æ ‡é¡¹ç›®å’Œåˆ†æ”¯ã€‚

Requestï¼ˆ`application/json`ï¼‰ï¼š
```json
{
  "nodeId": "string (å¿…éœ€) - è¿œç¨‹èŠ‚ç‚¹ ID",
  "repositoryUrl": "string (å¿…éœ€) - ç›®æ ‡é¡¹ç›®ï¼ˆGit ä»“åº“ URLï¼‰",
  "branch": "string (å¿…éœ€) - è¦å…‹éš†çš„ç›®æ ‡åˆ†æ”¯",
  "targetDir": "string (å¯é€‰) - ç›®æ ‡ç›®å½•åç§°ï¼Œå¦‚æœä¸æä¾›åˆ™è‡ªåŠ¨ç”Ÿæˆ"
}
```

Responseï¼š
```json
{
  "success": true,
  "data": {
    "targetDir": "string - å…‹éš†ä»“åº“çš„å®Œæ•´è·¯å¾„",
    "output": "string - å‘½ä»¤è¾“å‡º"
  },
  "error": "string (å¦‚æœ success ä¸º false)"
}
```

**æ³¨æ„ï¼š** æ­¤ç«¯ç‚¹ä½¿ç”¨è¿œç¨‹èŠ‚ç‚¹é…ç½®ï¼ˆä¸»æœºã€ç«¯å£ã€ç”¨æˆ·åã€å·¥ä½œä¸»ç›®å½•ã€SSH APIã€SSH API å¯†é’¥ã€SSH å¯†ç æˆ– SSH ç§é’¥ï¼‰é€šè¿‡ SSH æ‰§è¡Œ git å…‹éš†æ“ä½œã€‚è¯¥æ“ä½œä½¿ç”¨åµŒå…¥åœ¨ SSH æœåŠ¡ API ä¸­çš„ bash æ¨¡æ¿è„šæœ¬ï¼Œä»¥ç¡®ä¿å¯é çš„ä»“åº“å…‹éš†ã€‚

#### è·å– AI æä¾›å•†åˆ—è¡¨
```
GET /api/ai/providers
```

Response:
```json
{
  "success": true,
  "data": {
    "enabled": true,
    "providers": ["openai", "anthropic", "custom"],
    "message": "AI å†²çªè§£å†³å·²å¯ç”¨"
  }
}
```

#### æµ‹è¯• AI æä¾›å•†
```
POST /api/ai/test-providers
```

Response:
```json
{
  "success": true,
  "data": [
    {
      "provider": "openai",
      "success": true,
      "latency": 1200,
      "error": null
    },
    {
      "provider": "anthropic",
      "success": true,
      "latency": 800,
      "error": null
    }
  ]
}
```

#### è·å– Gerrit é¡¹ç›®åˆ—è¡¨
```
GET /api/projects
```

æŸ¥è¯¢å‚æ•°ï¼ˆå¯é€‰ï¼‰ï¼š
- `prefix` - æŒ‰å‰ç¼€è¿‡æ»¤é¡¹ç›®ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
- `substring` - æŒ‰å­å­—ç¬¦ä¸²è¿‡æ»¤é¡¹ç›®ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
- `regex` - æŒ‰æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤é¡¹ç›®
- `limit` - é™åˆ¶ç»“æœæ•°é‡
- `skip` - è·³è¿‡ç»“æœæ•°é‡
- `all` - åŒ…å«éšè—é¡¹ç›®ï¼ˆé»˜è®¤ï¼šfalseï¼Œ**æ³¨æ„ï¼š** å¤§å¤šæ•° Gerrit å®ä¾‹ä¸­æ­¤é€‰é¡¹å·²è¢«ç¦ç”¨ï¼‰
- `state` - æŒ‰çŠ¶æ€è¿‡æ»¤ï¼šACTIVEã€READ_ONLY æˆ– HIDDEN
- `type` - æŒ‰ç±»å‹è¿‡æ»¤ï¼šALLã€CODE æˆ– PERMISSIONS
- `description` - åŒ…å«é¡¹ç›®æè¿°ï¼ˆé»˜è®¤ï¼šfalseï¼‰

ç¤ºä¾‹ï¼š
```
GET /api/projects?description=true
```

Response:
```json
{
  "success": true,
  "data": [
    {
      "id": "platform/frameworks/base",
      "name": "platform/frameworks/base",
      "description": "Android framework base"
    },
    {
      "id": "platform/packages/apps/Settings",
      "name": "platform/packages/apps/Settings",
      "description": "Settings app"
    }
  ]
}
```

#### è·å–é¡¹ç›®çš„åˆ†æ”¯åˆ—è¡¨
```
GET /api/projects/:project/branches
```

è·¯å¾„å‚æ•°ï¼š
- `project` - é¡¹ç›®åç§°ï¼ˆURL ç¼–ç ï¼Œä¾‹å¦‚ï¼š`platform%2Fframeworks%2Fbase`ï¼‰

ç¤ºä¾‹ï¼š
```
GET /api/projects/platform%2Fframeworks%2Fbase/branches
```

Response:
```json
{
  "success": true,
  "data": [
    {
      "ref": "refs/heads/main",
      "revision": "abc123def456...",
      "name": "main"
    },
    {
      "ref": "refs/heads/master",
      "revision": "def456abc123...",
      "name": "master"
    },
    {
      "ref": "refs/heads/android14-release",
      "revision": "789ghi012jkl...",
      "name": "android14-release"
    }
  ]
}
```

**æ³¨æ„ï¼š** å½“åœ¨æäº¤é¡µé¢é€‰æ‹©é¡¹ç›®æ—¶ï¼Œåˆ†æ”¯ä¼šè‡ªåŠ¨è·å–å¹¶æ˜¾ç¤ºã€‚åœ¨é€‰æ‹©é¡¹ç›®ä¹‹å‰ï¼Œåˆ†æ”¯ä¸‹æ‹‰æ¡†å¤„äºç¦ç”¨çŠ¶æ€ã€‚"ç›®æ ‡é¡¹ç›®"å’Œ"ç›®æ ‡åˆ†æ”¯"ä¸‹æ‹‰æ¡†å‡æ”¯æŒå®æ—¶æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿæ‰¾åˆ°æ‰€éœ€çš„é¡¹ç›®æˆ–åˆ†æ”¯ã€‚

**ç¼“å­˜æœºåˆ¶ï¼š**
- **å®¢æˆ·ç«¯ç¼“å­˜ï¼š** é¡¹ç›®å’Œåˆ†æ”¯æ•°æ®ä¼šåœ¨æµè§ˆå™¨æœ¬åœ°ç¼“å­˜ 10 åˆ†é’Ÿï¼Œä»¥æå‡æ€§èƒ½ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡"ç›®æ ‡é¡¹ç›®"å’Œ"ç›®æ ‡åˆ†æ”¯"ä¸‹æ‹‰æ¡†æ—è¾¹çš„åˆ·æ–°æŒ‰é’®ï¼ˆğŸ”„ï¼‰æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ã€‚ç¼“å­˜æ•°æ®é€šè¿‡ localStorage æŒä¹…åŒ–ï¼Œé¡µé¢åˆ·æ–°åä»ç„¶æœ‰æ•ˆã€‚
- **æœåŠ¡ç«¯ç¼“å­˜ï¼š** Worker ä¹Ÿä¼šç¼“å­˜ API å“åº” 10 åˆ†é’Ÿï¼Œä»¥å‡å°‘å¯¹ Gerrit çš„è°ƒç”¨ã€‚è¦åœ¨éƒ¨ç½²æ—¶æ¸…é™¤æ‰€æœ‰æœåŠ¡ç«¯ç¼“å­˜ï¼Œè¯·åœ¨ `.env.local` ä¸­æ›´æ–° `CACHE_VERSION`ï¼ˆä¾‹å¦‚ä» `v1` æ”¹ä¸º `v2`ï¼‰ï¼Œè¿è¡Œ `npm run sync:env`ï¼Œç„¶åé‡æ–°éƒ¨ç½²ã€‚

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åŸºç¡€é…ç½®
- åˆ›å»º Cloudflare è´¦æˆ·
- å®‰è£… Wrangler CLI
- é…ç½® KV å‘½åç©ºé—´

### 2. AI æä¾›å•†é…ç½®
- è·å– OpenAI API å¯†é’¥
- è·å– Anthropic API å¯†é’¥ï¼ˆå¯é€‰ï¼‰
- é…ç½®è‡ªå®šä¹‰ AI æä¾›å•†ï¼ˆå¯é€‰ï¼‰

### 3. ç¯å¢ƒå˜é‡è®¾ç½®
åœ¨ Cloudflare Workers è®¾ç½®é¡µé¢æ·»åŠ æ‰€æœ‰å¿…è¦çš„ç¯å¢ƒå˜é‡ã€‚

### 4. åç«¯éƒ¨ç½²ï¼ˆCloudflare Workersï¼‰
```bash
# æ„å»º Worker
npm run build:worker

# éƒ¨ç½²åˆ° Cloudflare Workers
npm run deploy
# è¿™ä¼šè¿è¡Œï¼šnpm run build:worker && npx wrangler deploy

# æˆ–æ‰‹åŠ¨éƒ¨ç½²
wrangler deploy
```

### 5. å‰ç«¯éƒ¨ç½²ï¼ˆCloudflare Pagesï¼‰
```bash
# æ„å»ºå‰ç«¯
npm run build

# éƒ¨ç½²åˆ° Cloudflare Pages
wrangler pages deploy dist --project-name=patchx
```

**é‡è¦æç¤ºï¼šéƒ¨ç½²æ—¶çš„ç¯å¢ƒå˜é‡é…ç½®**

### D1 æ•°æ®åº“é…ç½®

1. **åˆ›å»º D1 æ•°æ®åº“ï¼š**
   ```bash
   # åˆ›å»ºç”Ÿäº§æ•°æ®åº“
   wrangler d1 create patchx-db

   # åˆ›å»º staging æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰
   wrangler d1 create patchx-db-staging
   ```

2. **æ›´æ–° wrangler.tomlï¼š**
   - ä»å‘½ä»¤è¾“å‡ºä¸­å¤åˆ¶ `database_id`
   - åœ¨ `wrangler.toml` ä¸­æ›´æ–° `d1_databases` éƒ¨åˆ†ï¼Œä½¿ç”¨å®é™…çš„æ•°æ®åº“ ID
   - **é‡è¦æç¤ºï¼š** ç¡®ä¿ `database_id` ä¸åˆ›å»ºçš„æ•°æ®åº“å®Œå…¨åŒ¹é…

3. **éªŒè¯æ•°æ®åº“ç»‘å®šï¼š**
   ```bash
   # åˆ—å‡ºæ‰€æœ‰ D1 æ•°æ®åº“ä»¥éªŒè¯æ•°æ®åº“æ˜¯å¦å­˜åœ¨
   wrangler d1 list

   # éªŒè¯ wrangler.toml ä¸­çš„ database_id æ˜¯å¦åŒ¹é…
   # è¾“å‡ºåº”æ˜¾ç¤ºæ‚¨çš„æ•°æ®åº“åŠå…¶ç›¸åŒçš„ ID
   ```

4. **åˆå§‹åŒ–æ•°æ®åº“ï¼š**
   ```bash
   # æœ¬åœ°å¼€å‘ï¼šåˆå§‹åŒ–æœ¬åœ°æ•°æ®åº“
   npm run db:init:confirm

   # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼šåˆå§‹åŒ–è¿œç¨‹ç”Ÿäº§æ•°æ®åº“
   bash scripts/reset-db.sh --init --env production --remote --confirm

   # é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²ï¼šåˆå§‹åŒ–è¿œç¨‹ staging æ•°æ®åº“
   bash scripts/reset-db.sh --init --env staging --remote --confirm
   ```

5. **æ•…éšœæ’é™¤ "D1 database binding (PATCHX_D1) is not configured" é”™è¯¯ï¼š**

   å¦‚æœæ‚¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çœ‹åˆ°æ­¤é”™è¯¯ï¼Œè¯·æ£€æŸ¥ï¼š

   a. **éªŒè¯æ•°æ®åº“æ˜¯å¦å­˜åœ¨ï¼š**
      ```bash
      wrangler d1 list
      ```
      ç¡®ä¿ `patchx-db` å­˜åœ¨å¹¶è®°ä¸‹å…¶ `database_id`

   b. **éªŒè¯ wrangler.toml é…ç½®ï¼š**
      - æ£€æŸ¥ `[env.production]` éƒ¨åˆ†æ˜¯å¦é…ç½®äº† `d1_databases`
      - éªŒè¯ `database_id` ä¸ `wrangler d1 list` ä¸­çš„ ID åŒ¹é…
      - ç¡®ä¿ `binding` è®¾ç½®ä¸º `"PATCHX_D1"`ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰

   c. **ä¿®å¤é…ç½®åé‡æ–°éƒ¨ç½²ï¼š**
      ```bash
      npm run deploy
      ```

   d. **åœ¨ Cloudflare ä»ªè¡¨æ¿ä¸­éªŒè¯ç»‘å®šï¼š**
      - è½¬åˆ° Cloudflare ä»ªè¡¨æ¿ â†’ Workers & Pages â†’ æ‚¨çš„ Worker
      - æ£€æŸ¥ Settings â†’ Variables â†’ D1 Database Bindings
      - ç¡®ä¿ `PATCHX_D1` ç»‘å®šå·²é…ç½®å¹¶æŒ‡å‘æ­£ç¡®çš„æ•°æ®åº“

   e. **å¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ï¼Œè¯·åˆ›å»ºå®ƒï¼š**
      ```bash
      wrangler d1 create patchx-db
      # ä»è¾“å‡ºä¸­å¤åˆ¶ database_id
      # ä½¿ç”¨æ–°çš„ database_id æ›´æ–° wrangler.toml
      # é‡æ–°éƒ¨ç½²ï¼šnpm run deploy
      ```

### ç¯å¢ƒå˜é‡åŒæ­¥

ä» `.env.local` åŒæ­¥ç¯å¢ƒå˜é‡åˆ° `wrangler.toml`ï¼š

**æ­¥éª¤ï¼š**
1. ç¡®ä¿æ‚¨çš„ `.env.local` åŒ…å«æ‰€éœ€å˜é‡ï¼ˆè§ `.env.example`ï¼‰ï¼š
   - `VITE_PUBLIC_SITE_URL`
   - `GERRIT_BASE_URL`ã€`GERRIT_USERNAME`ã€`GERRIT_PASSWORD`
   - `RESEND_API_KEY`ï¼ˆå¯é€‰ï¼Œç”¨äºé‚®ä»¶ï¼‰
   - `ADMIN_USER_PASSWORD`ã€`TEST_USER_PASSWORD`
   - `CACHE_VERSION`ï¼ˆé»˜è®¤ä¸º `v1`ï¼‰
2. å°†å®ƒä»¬åŒæ­¥åˆ° `wrangler.toml`ï¼š
   ```bash
   npm run sync:env
   ```
3. éƒ¨ç½² Workerï¼š
   ```bash
   npm run deploy
   ```

**æ³¨æ„ï¼š** è¦åœ¨éƒ¨ç½²æ—¶æ¸…é™¤æœåŠ¡ç«¯ç¼“å­˜ï¼Œè¯·åœ¨ `.env.local` ä¸­æ›´æ–° `CACHE_VERSION`ï¼ˆä¾‹å¦‚æ”¹ä¸º `v2`ï¼‰ï¼Œè¿è¡Œ `npm run sync:env`ï¼Œç„¶åé‡æ–°éƒ¨ç½²ã€‚

### Cloudflare Pages ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰

æ‚¨ä¹Ÿå¯ä»¥åœ¨ Cloudflare Pages ä»ªè¡¨æ¿ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

1. è¿›å…¥æ‚¨çš„ Cloudflare Pages é¡¹ç›®ä»ªè¡¨æ¿
2. å¯¼èˆªåˆ° **è®¾ç½®** â†’ **ç¯å¢ƒå˜é‡**
3. ä¸º **ç”Ÿäº§ç¯å¢ƒ**ï¼ˆä»¥åŠ **é¢„è§ˆç¯å¢ƒ**ï¼Œå¦‚éœ€è¦ï¼‰æ·»åŠ ä»¥ä¸‹å˜é‡ï¼š
   - `VITE_PUBLIC_SITE_URL` - æ‚¨çš„ç«™ç‚¹å…¬ç½‘åœ°å€ï¼ˆä¾‹å¦‚ï¼š`https://patchx.pages.dev`ï¼‰

**é‡è¦æç¤ºï¼š** D1 æ•°æ®åº“é€šè¿‡ `wrangler.toml` é…ç½®å¹¶ç»‘å®šåˆ° Workerã€‚ç¯å¢ƒå˜é‡ä¸­ä¸éœ€è¦æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æˆ–å‡­æ®ã€‚

### éƒ¨ç½²åçš„æœåŠ¡åœ°å€
- **å‰ç«¯ï¼ˆCloudflare Pagesï¼‰**: `https://patchx.pages.dev`
- **åç«¯ APIï¼ˆCloudflare Workersï¼‰**: `https://patchx-service.angersax.workers.dev`

### è‡ªåŠ¨é‡å®šå‘é…ç½®
å‰ç«¯é€šè¿‡ `_redirects` æ–‡ä»¶è‡ªåŠ¨å°† `/api/*` è¯·æ±‚è½¬å‘åˆ°åç«¯ Workersï¼Œæ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç ã€‚

## ğŸ“„ è®¸å¯è¯

Apache-2.0