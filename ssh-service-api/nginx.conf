server {
    listen 80;
    server_name supagraph.ai;

    # Redirect to HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name supagraph.ai;

    ssl_certificate /etc/nginx/certs/public.crt;
    ssl_certificate_key /etc/nginx/certs/private.key;

    # To allow special characters in headers
    ignore_invalid_headers off;
    # Allow any size file to be uploaded
    client_max_body_size 8192M;
    # To disable buffering
    proxy_buffering off;
    proxy_request_buffering off;

    # Health check endpoint
    location /api/ssh/health {
        proxy_pass http://ssh-service-api:7000/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout settings for health check
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
    }

    # Git-clone endpoint
    location /api/ssh/git-clone {
        proxy_pass http://ssh-service-api:7000/git-clone;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout settings
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Error handling
        proxy_intercept_errors on;
        error_page 502 503 504 = @ssh_service_error;
    }

    # Execute endpoint
    location /api/ssh/execute {
        proxy_pass http://ssh-service-api:7000/execute;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout settings
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Error handling
        proxy_intercept_errors on;
        error_page 502 503 504 = @ssh_service_error;
    }

    # SSH Service API endpoints (catch-all for other /api/ssh/* paths)
    location /api/ssh/ {
        proxy_pass http://ssh-service-api:7000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Timeout settings
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Error handling
        proxy_intercept_errors on;
        error_page 502 503 504 = @ssh_service_error;
    }

    # Redirect /api/ssh to /api/ssh/
    location = /api/ssh {
        return 301 /api/ssh/;
    }

    # Error handler
    location @ssh_service_error {
        default_type application/json;
        return 503 '{"success":false,"error":"SSH Service API is temporarily unavailable. Please check if the service is running."}';
    }

    # LiteLLM API Gateway endpoint
    location /openai/ {
        proxy_pass http://litellm:4000/;
        rewrite ^/openai/(.*)$ /$1 break;

        proxy_redirect default;
        proxy_buffering off;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Nginx-Proxy true;
        proxy_set_header Authorization $http_authorization;
        proxy_pass_header Authorization;

        # Timeout settings
        proxy_connect_timeout 3000s;
        proxy_send_timeout 3000s;
        proxy_read_timeout 3000s;
        send_timeout 3000s;
    }

    # Default location
    location / {
        return 404 '{"success":false,"error":"Endpoint not found. SSH Service API endpoints are available at /api/ssh/*, LiteLLM API Gateway at /openai/*"}';
    }
}
